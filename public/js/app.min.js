!function(){"use strict";var t,e,n,a,o,i,s,r,c=$("#cassette .wheel"),l=$("#chat"),d=$("#chat-outer-wrapper"),u=$("#countdown"),h=$("#feedback"),p=$("#guess"),m=$("#message"),v=$("#modal"),f=$("#summary .points"),g=$("#progress"),b=$("#summary .rank"),k=$("#recipient"),y=$("#tape-left"),w=$("#tape-right"),x=$("#toggle-chat"),C=$("#summary .track"),T=$("#tracks"),j=$("#users"),F=0,A=0,W=[],Y={},D=location.pathname.replace(/\//g,""),N=0,E=!1,I=/(https?:\/\/[\-A-Za-z0-9+&@#\/%?=~_()|!:,.;]*[\-A-Za-z0-9+&@#\/%=~_()|])/,P=[],M={},G=["Do you also know the title?","Exactly, now tell me the title!","Yes, that's the artist. What about the title?"],H=["Congratulations","Exactly","Excellent","Good job!","Great!","I'm proud of you","Keep it up!","Perfect","Super duper","That's it!","Very well done","Woohoo!","Yeah true, do you like this track?","Yes, you're right","You make it look easy","You remembered","You rock!"],O=["Are you kidding?","Don't give up","Fail","Haha, what?!","Incorrect answer","It is not that hard","Keep trying","No way!","No","Nope","Nope, sorry!","Oh, come on!","That's wrong","Try again","What?!","Wrong"],S=["A song is already playing, please wait for the next one...","Game is about to start...","Game is over","New game will start soon..."],U=["Correct, do you also know the artist?","Now tell me the artist!","Yes, you guessed the title. Who is the artist?"],_=function(){var n=['<div id="touch-backdrop">','<button id="touch-play" class="btn btn-danger disabled">','<i class="icon-play icon-white"></i> Wait',"</button>","</div>"].join(""),a=$(n);a.appendTo("#cassette"),t=$("#touch-play"),t.on("click",function(){$(this).hasClass("btn-danger")||(e.currentTime=F,e.play(),a.remove(),t=null)})},z=function(t){var e=$('<li class="entry"></li>');e.append(t),l.append(e),l[0].scrollTop=l[0].scrollHeight},L=function(t,e){h.removeClass().text(t),e&&(h.addClass(e),p.addClass(e),setTimeout(function(){p.removeClass(e)},350))},R=function(t){if(m.focus(),i&&B(),a!==t){i=t,k.css("margin-right","4px"),k.text("To "+t+":");var e=k.outerWidth(!0)+1;k.hide(),m.animate({width:"-="+e+"px"},"fast",function(){k.show()});var n=$(".name").filter(function(){return $(this).text()===t});n.prevAll(".private").show(),n.off("click").on("click",B)}},q=function(e){t&&(t.removeClass("btn-success").addClass("btn-danger disabled"),t.html('<i class="icon-play icon-white"></i> Wait')),n=!1,clearInterval(r),Z(Date.now()+5e3,!1);var a=e.artistName.replace(/"/g,"&quot;"),o=e.trackName.replace(/"/g,"&quot;"),i="",s="";if(N>0&&(s="+"+N,N>3)){var c=7-N;i+='class="icons round-rank stand'+c+'"'}var l=['<li class="bordered">','<img class="artwork" src="'+e.artworkUrl+'"/>','<div class="info">','<div class="artist" title="'+a+'">'+a+"</div>",'<div class="title" title="'+o+'">'+o+"</div>","</div>","<div "+i+"></div>",'<div class="round-points">'+s+"</div>",'<a class="icons" target="itunes_store" href="'+e.trackViewUrl+'"></a>',"</li>"].join("");T.prepend(l)},K=function(){var t=['<div id="volume-button">','<a class="button">','<div id="icon" class="icons volume-high"></div>',"</a>",'<div id="volume-slider">','<div id="volume-total"></div>','<div id="volume-current"></div>','<div id="volume-handle"></div>',"</div>","</div>"].join(""),n=$(t),a=n.find("#icon"),o=n.find("#volume-current"),i=n.find("#volume-handle"),s=n.find("#volume-slider"),r=n.find("#volume-total"),c=!1,l=!1,d=!1,u=1;n.appendTo("#volume");var h=function(t){0===t?a.removeClass().addClass("icons volume-none"):.33>=t?a.removeClass().addClass("icons volume-low"):.66>=t?a.removeClass().addClass("icons volume-medium"):a.removeClass().addClass("icons volume-high")},p=function(t){var e=r.height(),n=r.offset(),a=parseInt(r.css("top").replace(/px/,""),10),s=t.pageY-n.top,l=(e-s)/e;c=!1,0>s?s=0:s>e&&(s=e),o.height(e-s),o.css("top",s+a),i.css("top",a+s-i.height()/2),l=Math.max(0,l),l=Math.min(l,1),f(l)},m=function(t){if(!s.is(":visible"))return s.show(),m(t),s.hide();var e=r.height(),n=r.position(),a=e-e*t;o.height(e-a),o.css("top",n.top+a),i.css("top",n.top+a-i.height()/2)},v=function(t){var e=new Date;e.setTime(e.getTime()+31536e6),document.cookie="volume="+t+";path=/;expires="+e.toGMTString()+";"},f=function(t){h(t),e.volume=t,u=t,v(t)};n.find(".button").on("click",function(){return c?(c=!1,void(0!==u&&(h(u),e.volume=u,m(u)))):(c=!0,void(0!==u&&(h(0),e.volume=0,m(0))))}),n.hover(function(){d=!0,s.show()},function(){d=!1,l||s.hide()}),s.on("mouseover",function(){d=!0}).on("mousedown",function(t){return p(t),l=!0,!1}),$(document).on("mouseup",function(){l=!1,d||s.hide()}).on("mousemove",function(t){l&&p(t)}),function(){if(/volume\s*\=/.test(document.cookie)){var t=document.cookie.replace(/.*volume\s*\=\s*([^;]*);?.*/,"$1");return t=parseFloat(t),m(t),f(t)}m(1)}()},V=function(){var t=['<div class="modal-header">',"<h3>Already in a room</h3>","</div>",'<div class="modal-body">','<div class="alert alert-error alert-block">','<h4 class="alert-heading">Warning!</h4>',"You are already in a room.<br/>","Leave the other room and refresh this page or close this one.","</div>","</div>"].join("");$(t).appendTo(v),v.modal("show")},Z=function(e,n){var a,o,i,s,l,d,h,p;(h=function(){return i=e-Date.now(),d=i/1e3,50>i?clearInterval(r):(n?(t&&(F=30-Math.round(d)),u.text(d.toFixed(1)),o=d/30,p=148-148*o,a=-360+360*o,s=20+24*o,l=106+24*o):(u.text(Math.round(d)),o=d/5,p=148*o,a=-360*o,s=44-24*o,l=130-24*o),c.css("transform","rotate("+a+"deg)"),g.width(p),y.css("left",s+"px"),void w.css("left",l+"px"))})(),r=setInterval(h,50)},J=function(t){if(t=t?'<span class="label label-important">'+t+"</span><br/>Try with another one:":"What's your name?",v.hasClass("in"))return $(".modal-body p").html(t),$("#login").focus();var e=['<div class="modal-header">',"<h3>You are joining the "+D+" room</h3>","</div>",'<div class="modal-body">',"<p>"+t+"</p>","</div>",'<div class="modal-footer relative">','<input id="login" maxlength="15" type="text" name="nickname" />','<button id="join" class="btn btn-success">','<i class="icon-user icon-white"></i> Join the game',"</button>",'<span class="divider">',"<span>or</span>","</span>",'<a class="btn btn-primary" href="/login?followup=/'+D+'">','<i class="icon-lock icon-white"></i> Login',"</a>","</div>"].join("");$(e).appendTo(v);var n=$("#join"),a=$("#login");n.on("click",function(){var t=a.val();return a.val(""),t.trim()?o.send("nickname",t):void J("Nickname can't be empty.")}),a.on("keyup",function(t){13===t.keyCode&&n.click()}),v.modal("show").on("shown",function(){a.focus()})},B=function(){var t=k.outerWidth(!0)+1;k.css("margin-right","0"),k.text(""),m.animate({width:"+="+t+"px"},"fast");var e=$(".name").filter(function(){return $(this).text()===i});e.prevAll(".private").hide(),e.off("click").on("click",function(){R($(this).text())}),i="",m.focus()},Q=function(t){var e=t-Date.now(),n=e/1e3;$(".modal-footer span").text(Math.round(n)),200>e||setTimeout(function(){Q(t)},200)},X=function(){clearInterval(r),e.pause(),z($('<span class="error">ERROR: You have disconnected.</span>')),L("Something wrong happened"),j.empty()},tt=function(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},et=function(t){var e=['<div class="modal-header">',"<h3>Game Over</h3>","</div>",'<div class="modal-body">','<table class="table table-striped scoreboard">',"<thead>","<tr>","<th>#</th>","<th>Name</th>","<th>Points</th>",'<th><div class="icons cups stand1"></div></th>','<th><div class="icons cups stand2"></div></th>','<th><div class="icons cups stand3"></div></th>',"<th>Guessed</th>","<th>Mean time</th>","</tr>","</thead>","<tbody>"];t.forEach(function(t,n){e.push("<tr>"),e.push('<td><div class="icons medals rank'+(n+1)+'"></div></td>'),e.push('<td class="name">'+t.nickname+"</td>"),e.push("<td>"+t.points+"</td>"),e.push("<td>"+t.golds+"</td>"),e.push("<td>"+t.silvers+"</td>"),e.push("<td>"+t.bronzes+"</td>"),e.push("<td>"+t.guessed+"</td>");var a="N/A";0!==t.guessed&&(a=t.totguesstime/t.guessed,a=(a/1e3).toFixed(1)+" s"),e.push("<td>"+a+"</td>"),e.push("</tr>")}),e.push("</tbody>","</table>","</div>"),e.push('<div class="modal-footer align-left">'),e.push("A new game will start in <span></span> second/s"),e.push("</div>"),v.append(e.join("")).modal("show"),Q(Date.now()+1e4)},nt=function(t,e,n){if(!Y[e]){var o=$('<span class="message"></span>'),i=e;n&&(a===e?i="(To "+n+")":(i="(From "+e+")",s=e),o.addClass("private"));var r=i+": "+t.replace(/<3/g,"â™¥");o.html(wt(r)),z(o)}},at=function(){d.toggle(300),x.text("Show chat"),x.off("click").on("click",pt),T.animate({maxHeight:"434px"},300)},ot=function(t,e){return Y[t[0]]?(e.text("(From binb): "+t[0]+" is already ignored."),z(e)):void o.send("ignore",t[0],function(t,n){return t?(Y[n]=!0,e.text("(From binb): "+n+" is now ignored."),z(e)):(e.append("player not found."),void z(e))})},it=function(t){e.src=t},st=function(t){for(var e=!1,n="",a=[],o=0;o<t.length;o++)if("\\"!==t[o])if('"'!==t[o])" "!==t[o]?n+=t[o]:e?n+=" ":n.length&&(a.push(n),n="");else{e=!e;var i=o+1;e||" "!==t[i]&&i!==t.length||(a.push(n),n="",o=i)}else{if(++o===t.length)throw new Error("SyntaxError: Unexpected end of input");if("\\"===t[o]||'"'===t[o]||!e){n+=t[o];continue}n+="\\"+t[o]}if(e)throw new Error("SyntaxError: Unexpected end of input");return n.length&&a.push(n),a},rt=function(a){t&&(t.html('<i class="icon-play icon-white"></i> Play'),t.removeClass("btn-danger disabled").addClass("btn-success")),e.play(),p.val(""),n=!0,clearInterval(r),Z(Date.now()+3e4,!0),kt(a.users),1===a.counter&&(v.modal("hide").empty(),T.empty()),C.text(a.counter+"/"+a.tot),L("What is this song?")},ct=function(t){return function(e,n){if(n.append("you are not allowed to "+t+" a player."),!E)return z(n);var a=[t,e[0]];"kick"===t?a.push(e[1]||""):e[1]?e[2]?a.push(e[1],e[2]):/^[1-9][0-9]*$/.test(e[1])?a.push("",e[1]):a.push(e[1],""):a.push("",""),a.push(function(t){t||z(n)}),o.send.apply(o,a)}},lt=function(t,e){var n=t.length;return function(){var a=Math.floor(Math.random()*n),o=t[a];L(o,e)}},dt=function(t){a=t.nickname,t.loggedin?E=!0:document.cookie="nickname="+a+";path=/;",v.modal("hide").empty(),$("#total-tracks span").text(t.trackscount);var e=$('<span class="join">'+a+" joined the game</span>");z(e),kt(t.usersData),m.on("keydown",function(t){if(13===t.keyCode){var e=m.val().trim();if(m.val(""),e){if(/^\/[^ ]/.test(e))return mt(e);if(i)return o.send("chatmsg",e,i);o.send("chatmsg",e)}}}),p.on("keydown",function(t){switch(t.keyCode){case 13:var e=p.val().trim();if(p.val(""),e){if(W.push(e),W.length>20&&W.splice(0,1),A=W.length,n)return o.send("guess",e.toLowerCase());L("You have to wait the next song...")}break;case 38:return A>0&&p.val(W[--A]),!1;case 40:if(A<W.length-1)return p.val(W[++A]);A=W.length,p.val("")}}).on("paste",function(t){t.preventDefault()}).focus(),o.on("artistmatched",lt(G,"correct")),o.on("bothmatched",lt(H,"correct")),o.on("chatmsg",nt),o.on("gameover",et),o.on("loadtrack",it),o.on("newuser",xt),o.on("nomatch",lt(O,"wrong")),o.on("playtrack",rt),o.on("stoptrying",function(){L("You guessed both artist and title. Please wait...")}),o.on("titlematched",lt(U,"correct")),o.on("trackinfo",q),o.on("updateusers",kt),o.on("userleft",$t),ht(t.state)},ut=function(t){$(".users-counter").each(function(){var e=$(this).prevAll(".room-name").text();M[e]=$(this),$(this).text(t[e])})},ht=function(t){0===t.status?(n=!0,Z(Date.now()+t.timeleft,!0)):1===t.status&&it(t.previewUrl),L(S[t.status])},pt=function(){d.toggle(300),x.text("Hide chat"),x.off("click").on("click",at),T.animate({maxHeight:"240px"},300,function(){l[0].scrollTop=l[0].scrollHeight})},mt=function(t){var e,n=$('<span class="message private">(From binb): </span>');try{e=st(t)}catch(o){return n.append(o.message),z(n)}var i=e.shift(),s=Ct[i.substr(1)];return s?e.length<s.minargs?(n.append(s.usage),z(n)):!s.checkrecipient||e[0]&&e[0]!==a?s.fn(e,n):(n.append("invalid argument."),z(n)):(n.text("(From binb): unknown command "+i+"."),void z(n))},vt=function(t,e){return~P.indexOf(t[0])?void R(t[0]):(e.text("(From binb): There's no one here by that name."),z(e))},ft=function(t,e){return s?~P.indexOf(s)?void R(s):(e.text("(From binb): "+s+" isn't here anymore."),z(e)):(e.text("(From binb): There's no one to reply to."),z(e))},gt=function(t,e){return e.append("you are not allowed to unban a player."),E?void o.send("unban",t[0],function(t){t||z(e)}):z(e)},bt=function(t,e){return Y[t[0]]?(delete Y[t[0]],o.send("unignore",t[0]),e.text("(From binb): "+t[0]+" is no longer ignored."),void z(e)):(e.text("(From binb): you have not ignored "+t[0]+"."),z(e))},kt=function(t){j.empty(),P=Object.keys(t).sort(function(e,n){return t[n].points-t[e].points});var e=!1;if(P.forEach(function(n,o){n=t[n];var s=$('<span class="guess-time"></span>'),r=$("<li></li>"),c=$('<span class="points">('+n.points+")</span>"),l=$('<span class="private label label-info">P</span>'),d=$('<span class="round-points"></span>'),u=$("<span></span>"),h=$('<span class="name">'+n.nickname+"</span>");if(r.append(l,h,c,u,d,s),n.registered){var p='href="/user/'+n.nickname+'"';l.after('<a class="icons registered" target="_blank" '+p+"></a>")}if(j.append(r),i===n.nickname?(l.show(),h.on("click",B),e=!0):h.on("click",function(){R($(this).text())}),a===n.nickname&&(f.text(n.points),b.text(o+1),h.addClass("you"),N=n.roundpoints),n.roundpoints>0){if(d.text("+"+n.roundpoints),"artist"===n.matched||"title"===n.matched)return h.addClass("matched"+n.matched);h.addClass("correct"),n.roundpoints>2&&s.text((n.guesstime/1e3).toFixed(1)+" s"),n.roundpoints>3&&u.addClass("icons round-rank stand"+(7-n.roundpoints))}}),!e&&i){i="";var n=k.outerWidth(!0)+1;k.css("margin-right","0"),k.text(""),m.animate({width:"+="+n+"px"},"fast")}},yt=function(t,e){t!==D&&M[t].text(e)},wt=function(t){if(I.test(t)){for(var e="",n=t.split(I),a=0;a<n.length;a++){var o=tt(n[a]);e+=I.test(n[a])?'<a target="_blank" href="'+o+'">'+o+"</a>":o}return e}return tt(t)},xt=function(t,e){var n=$('<span class="join">'+t+" joined the game</span>");z(n),kt(e)},$t=function(t,e){var n=$('<span class="left">'+t+" left the game</span>");z(n),kt(e)},Ct={ban:{checkrecipient:!0,fn:ct("ban"),minargs:1,usage:"usage: /ban &lt;player&gt; [&lt;message&gt;] [&lt;duration&gt;]"},clear:{fn:function(){l.empty()},minargs:0},ignore:{checkrecipient:!0,fn:ot,minargs:1,usage:"usage: /ignore &lt;player&gt;"},kick:{checkrecipient:!0,fn:ct("kick"),minargs:1,usage:"usage: /kick &lt;player&gt; [&lt;message&gt;]"},unban:{fn:gt,minargs:1,usage:"usage: /unban &lt;IP&gt;|list"},unignore:{checkrecipient:!0,fn:bt,minargs:1,usage:"usage: /unignore &lt;player&gt;"},"private":{checkrecipient:!0,fn:vt,minargs:1,usage:"usage: /private &lt;player&gt;"},reply:{fn:ft,minargs:0},unprivate:{fn:B,minargs:0}};v.modal({backdrop:"static",keyboard:!1,show:!1}),x.click(at),e=new Audio,e.preload="auto",e.volume=1,/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)?_():K(),o=new Primus({url:location.protocol+"//"+location.host+"?room="+D,strategy:!1}),o.on("updateoverview",yt),o.on("alreadyinaroom",V),o.on("nickname",J),o.on("overview",ut),o.on("end",X),o.on("ready",dt)}();